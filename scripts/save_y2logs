#!/bin/bash
#
# save_y2logs - save YaST2 logs to a compressed tar file
#		to attach it to a Bugzilla bug report
#
# Author: Stefan Hundhammer <sh@suse.de>

PATH=/usr/sbin:/usr/bin:/sbin:/bin

usage()
{
    echo "Usage: ${0##*/} [ARCHIVE_NAME]" >&2
    echo "" >&2
    echo "Copies the YaST2 logs to a (compressed) tar archive." >&2
    echo "If file name is missing it is generated by the script." >&2
    exit 1
}

if test -z "$1"; then
  # choose some good default
  if [ "$(type -p xz)" ] ; then
    SUFFIX=.tar.xz
    COMPRESSION=xz
  elif [ "$(type -p gzip)" ] ; then
    SUFFIX=.tar.gz
    COMPRESSION=gzip
  elif [ "$(type -p bzip2)" ] ; then
    SUFFIX=.tar.bz2
    COMPRESSION=bzip2
  else
    SUFFIX=.tar
    COMPRESSION=
  fi
  TARGET=`mktemp --suffix $SUFFIX /tmp/y2log-XXXXXX`
else
  case "$1" in
    -*)
	usage
	;;

    *.tar)
	COMPRESSION=
	;;

    *.tgz|*.tar.gz)
	COMPRESSION=gzip
	;;

    *.txz|*.tar.xz)
	COMPRESSION=xz
	;;

    *.tar.bz2)
	COMPRESSION=bzip2
	;;

    *)
	echo "FATAL: argument is not a (compressed) tar file." >&2
	echo "Use one of these suffixes: .tar .tgz .tar.gz .txz .tar.xz .tar.bz2" >&2
	exit 4
  esac
  # use full path
  TARGET=$(readlink -m "$1")
fi

# check for compression program
if [ "$COMPRESSION" -a -z "$(type -p $COMPRESSION)" ]; then
  echo "FATAL: $COMPRESSION not available" >&2
  exit 3
fi

TMPDIR=`mktemp -d` || ( echo "FATAL: Failed to create a temporary directory" >&2; exit 5 );


# 1. gather some information in $TMPDIR

# last kernel messages, if any
if [ "$(type -p dmesg)" ]; then
  dmesg > $TMPDIR/dmesg
  LIST_TMP="$LIST_TMP dmesg"
fi

if [ "$(type -p journalctl)" ]; then
  journalctl -b > $TMPDIR/journalctl-b
  LIST_TMP="$LIST_TMP journalctl-b"
fi

# strip sensitive information
if [ -f /etc/install.inf ]; then
  sed 's/\(^WlanESSID: \|^WlanKey: \|^RootPassword: \|^VNCPassword: \|^Password: \).*$/\1XXXXXX/' </etc/install.inf >$TMPDIR/install.inf
  LIST_TMP="$LIST_TMP install.inf"
fi

MACRO_INST=/var/log/YaST2/macro_inst_initial.ycp

if [ -f $MACRO_INST ]; then
    # bsc#1251768: Don't leak registration code or e-mail to the y2logs tarball
    #
    # UI::ChangeWidget( `id (`email),    `Value, "kilroy@example.com" ); // YInputField ...
    # UI::ChangeWidget( `id (`reg_code), `Value, "MY-REG-CODE" );        // YInputField ...
    #
    # -->
    #
    # UI::ChangeWidget( `id (`email),	 `Value, [confidential] ); // YInputField ...
    # UI::ChangeWidget( `id (`reg_code), `Value, [confidential] ); // YInputField ...
    #
    # Intentionally doing this in-place in the real /var/log/YaST2/macro_inst_initial.ycp

    sed -i -E \
        -e '/id.*(reg_code|email).*YInputField/s/(Value,\s)[^)]+(.*$)*/\1[confidential] \2/' \
        $MACRO_INST
fi

# if storing logs at the end of installation after bootloader fail, try to store pbl log from target system
if [ -f /mnt/var/log/pbl.log ]; then
  cp /mnt/var/log/pbl.log $TMPDIR/pbl-target.log
  LIST_TMP="$LIST_TMP pbl-target.log"
fi

# installed packages
if [ -f /var/lib/rpm/Packages -o -f /var/lib/rpm/Packages.db ] && [ "$(type -p rpm)" ]; then
  rpm -qa --qf '%{NAME}-%{VERSION}-%{RELEASE}\t\t\t(%{VENDOR})\t%{DISTRIBUTION}\n' 2>/dev/null | sort >/$TMPDIR/rpm-qa
  LIST_TMP="$LIST_TMP rpm-qa"
fi

# rename, so people can see it
if [ -f /.packages.root ]; then
  cp /.packages.root $TMPDIR/_packages.root
  LIST_TMP="$LIST_TMP _packages.root"
fi


# 2. things from /var/log relevant for us

VAR_LOG_FILES='\
  YaST2 \
  Xorg.0.log \
  zypper.log zypp/history* pk_backend_zypp \
  pbl.log linuxrc.log wickedd.log \
  evms-engine.* \
  boot.msg messages udev.log \
'
cd /var/log
for i in $VAR_LOG_FILES ; do
  [ -e "$i" ] && LIST_VAR="$LIST_VAR $i"
done
cd /


# 3. any other files

FILES='\
  etc/X11/xorg.conf etc/X11/xorg.conf.install \
  etc/X11/xorg.conf.d linuxrc.config etc/os-release \
'
for i in $FILES ; do
  [ -e "$i" ] && LIST="$LIST $i"
done


echo "Saving YaST logs to $TARGET" >&2
echo "The archive is root readable only" >&2

[ -n "$COMPRESSION" ] && COMPRESSION="--$COMPRESSION"

tar cf "$TARGET" --warning=no-file-changed $COMPRESSION --dereference -C / $LIST -C /var/log $LIST_VAR -C $TMPDIR $LIST_TMP
err=$?

rm -rf $TMPDIR

# tar returns 1 when content of tarball is older than the current system. Happen when something still writting to logs or memsampler (bsc#1182710#c2)
[ $err == 1 ] && echo "Warning: logs modified during save. Yast is probably running. Content of tarball can be older than current content." >&2 && err=0

[ $err != 0 ] && echo "FATAL: Error creating archive $TARGET" >&2

exit $err
